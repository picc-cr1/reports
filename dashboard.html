<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PICC CR1 Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary: #6366f1;
  --green: #22c55e;
  --yellow: #facc15;
  --red: #f87171;
  --bg: #f8fafc;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: #e5e7eb;
  --radius: 16px;
  --shadow-sm: 0 4px 10px rgba(0,0,0,.05);
  --shadow-md: 0 20px 40px rgba(0,0,0,.08);
}

/* BASE */
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Inter', sans-serif; background: var(--bg); color: var(--text); line-height:1.6; }
a { text-decoration:none; color:inherit; }
.container { max-width:1080px; margin: 20px auto; padding: 0 15px; }

/* NAVBAR */
.plug-nav {
  display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
  padding:0.9rem 1.4rem; background-color:#0f172a; color:#fff;
}
.plug-nav__brand { font-weight:700; font-size:1.05rem; letter-spacing:0.04em; }
.plug-nav__brand span { color: var(--primary); }
.plug-nav__links { list-style:none; display:flex; align-items:center; gap:1.5rem; }
.plug-nav__links a { color:#e5e7eb; font-size:0.95rem; font-weight:500; }
.plug-nav__links a:hover, .plug-nav__links a.active { color:#fff; }
.plug-nav__cta { padding:0.4rem 0.9rem; border-radius:999px; background-color:var(--primary); color:#fff; font-weight:600; }
.plug-nav__toggle { display:none; background:none; border:none; color:#fff; font-size:1.6rem; cursor:pointer; }

@media(max-width:768px){
  .plug-nav__toggle { display:block; }
  .plug-nav__links { display:none; flex-direction:column; gap:0.8rem; margin-top:0.8rem; width:100%; }
  .plug-nav__links.show { display:flex; }
}

/* HERO */
.hero {
  background: radial-gradient(1200px 500px at top right, rgba(99,102,241,0.15), transparent 60%), var(--surface);
  border-radius: var(--radius);
  padding: 30px 20px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  margin-bottom: 2rem;
  text-align:center;
}
.hero h1 { font-size:1.6rem; font-weight:700; color:#2980b9; margin-bottom:12px; }
.hero p { font-size:0.95rem; color:var(--muted); max-width:700px; margin:0 auto 1rem; }

/* FILTERS */
.filters { display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; margin-bottom:16px; align-items:end; }
.filters label { font-size:0.85rem; color:var(--text); display:flex; flex-direction:column; }
.filters select, .filters input { padding:6px 8px; border-radius:6px; border:1px solid var(--border); }
.filters button { padding:6px 12px; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer; }

/* KPI CARDS */
.kpi-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-bottom:20px; }
.kpi { background:var(--surface); border-radius:var(--radius); padding:12px 16px; text-align:center; box-shadow:var(--shadow-sm); }
.kpi small { color:var(--muted); font-size:0.75rem; display:block; margin-bottom:4px; }
.kpi strong { font-size:1.4rem; font-weight:700; color:var(--text); }
.kpi.highlight { border-left:4px solid var(--primary); }

/* CHARTS */
.chart-grid { display:grid; grid-template-columns:1fr; gap:16px; }
.chart-card { background:var(--surface); border-radius:var(--radius); padding:12px; box-shadow:var(--shadow-sm); width:100%; overflow:hidden; }
.chart-card h3 { font-size:0.9rem; margin-bottom:8px; color:var(--text); text-align:center; }
.chart-wrap { position:relative; height:220px; }

@media(min-width:768px){
  .chart-grid { grid-template-columns: repeat(2,1fr); }
  .chart-wrap { height:260px; }
}
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="plug-nav">
  <div class="plug-nav__brand">PICC <span>CR1</span></div>
  <button class="plug-nav__toggle">&#9776;</button>
  <ul class="plug-nav__links">
    <li><a href="index.html">Home</a></li>
    <li><a href="post.html">Post Report</a></li>
    <li><a href="reports.html">Reports</a></li>
    <li><a href="dashboard.html" class="plug-nav__cta">Dashboard</a></li>
  </ul>
</nav>

<main class="container">

  <!-- HERO -->
  <section class="hero">
    <h1>Dashboard Overview</h1>
    <p>Track attendance, offerings, heritage, and service trends across all PICC CR1 branches.</p>
  </section>

  <!-- FILTERS -->
  <section class="filters">
    <label>Branch <select id="branchSelect"><option value="">All</option></select></label>
    <label>From <input type="date" id="dateFrom"/></label>
    <label>To <input type="date" id="dateTo"/></label>
    <button id="resetFilters">Reset</button>
  </section>

  <!-- KPI CARDS -->
  <section class="kpi-grid">
    <div class="kpi"><small>Total Attendance</small><strong id="totalAttendance">0</strong></div>
    <div class="kpi"><small>Total Male</small><strong id="totalMale">0</strong></div>
    <div class="kpi"><small>Total Female</small><strong id="totalFemale">0</strong></div>
    <div class="kpi"><small>Total Branches</small><strong id="totalBranches">0</strong></div>
    <div class="kpi highlight"><small>Average Attendance / Service</small><strong id="avgAttendance">0</strong></div>
    <div class="kpi"><small>Top Performing Branch</small><strong id="topBranch">-</strong></div>
    <div class="kpi highlight"><small>Offering per Attendee</small><strong id="offeringPerPerson">0</strong></div>
    <div class="kpi"><small>Total First-Timers</small><strong id="totalFirstTimers">0</strong></div>
    <div class="kpi"><small>Total New Converts</small><strong id="totalNewConverts">0</strong></div>
    <div class="kpi"><small>Conversion Rate %</small><strong id="conversionRate">0</strong></div>
    <div class="kpi"><small>Total Heritage Attendance</small><strong id="totalHeritage">0</strong></div>
  </section>

  <!-- CHARTS -->
  <section class="chart-grid">
    <div class="chart-card"><h3>Attendance by Branch</h3><div class="chart-wrap"><canvas id="branchChart"></canvas></div></div>
    <div class="chart-card"><h3>Attendance by Service Type</h3><div class="chart-wrap"><canvas id="serviceChart"></canvas></div></div>
    <div class="chart-card"><h3>Gender Distribution</h3><div class="chart-wrap"><canvas id="genderChart"></canvas></div></div>
    <div class="chart-card"><h3>Offering Distribution</h3><div class="chart-wrap"><canvas id="offeringsChart"></canvas></div></div>
    <div class="chart-card"><h3>Heritage vs Visitors</h3><div class="chart-wrap"><canvas id="heritageChart"></canvas></div></div>
  </section>

</main>

<script>
// NAV TOGGLE
const toggleBtn = document.querySelector('.plug-nav__toggle');
const navLinks = document.querySelector('.plug-nav__links');
toggleBtn.addEventListener('click', () => navLinks.classList.toggle('show'));

// Highlight current page
document.querySelectorAll('.plug-nav__links a').forEach(link=>{
  const href = link.getAttribute('href').toLowerCase();
  const current = window.location.pathname.split('/').pop().toLowerCase();
  if(href===current || (href==='index.html' && current==='')) link.classList.add('active');
});

// WEB APP URL
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3tGmvmBCkLxMpnfZwJSS6nwVXV2cj2NcBEXlLVLe2PdegU0Enw3R3qHcnzS5GxWdX/exec?action=getReports";

// GLOBAL CHARTS
let branchChart, serviceChart, genderChart, offeringsChart, heritageChart;

function normalizeDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}/.test(val)) return val.substring(0,10);
  const d = new Date(val);
  if(isNaN(d)) return "";
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

async function initDashboard(){
  const res = await fetch(WEB_APP_URL);
  const data = await res.json();
  const reports = data.reports || [];
  if(!reports.length) return;

  const branchSelect = document.getElementById("branchSelect");
  const branchesSet = new Set(reports.map(r=>r.branch));
  branchesSet.forEach(b=>branchSelect.innerHTML += `<option value="${b}">${b}</option>`);

  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const resetBtn = document.getElementById("resetFilters");

  function filterReports(){
    let filtered = [...reports];
    if(branchSelect.value) filtered = filtered.filter(r=>r.branch===branchSelect.value);
    if(dateFrom.value) filtered = filtered.filter(r=>normalizeDate(r.serviceDate) >= dateFrom.value);
    if(dateTo.value) filtered = filtered.filter(r=>normalizeDate(r.serviceDate) <= dateTo.value);
    return filtered;
  }

  function renderDashboard(){
    const filtered = filterReports();
    if(!filtered.length){
      ["totalAttendance","totalMale","totalFemale","totalBranches","avgAttendance","topBranch","offeringPerPerson","totalFirstTimers","totalNewConverts","conversionRate","totalHeritage"].forEach(id=>document.getElementById(id).textContent = id.includes("topBranch") ? "-" : 0);
      return;
    }

    // Aggregate KPIs
    let totalAttendance=0, totalMale=0, totalFemale=0, totalOfferings=0, totalFirstTimers=0, totalNewConverts=0, totalHeritage=0;
    const branches={}, services={}, gender={Male:0,Female:0};
    filtered.forEach(r=>{
      totalAttendance+=r.attendanceTotal;
      totalMale+=r.attendanceMale;
      totalFemale+=r.attendanceFemale;
      totalOfferings+=r.offeringFreeWill+r.offeringTithe+r.offeringThanksgiving;
      totalFirstTimers+=r.firstTimers;
      totalNewConverts+=r.newConverts;
      totalHeritage+=r.heritage;
      branches[r.branch]=(branches[r.branch]||0)+r.attendanceTotal;
      services[r.serviceType]=(services[r.serviceType]||0)+r.attendanceTotal;
      gender.Male+=r.attendanceMale;
      gender.Female+=r.attendanceFemale;
    });

    // Update KPI cards
    document.getElementById("totalAttendance").textContent = totalAttendance;
    document.getElementById("totalMale").textContent = totalMale;
    document.getElementById("totalFemale").textContent = totalFemale;
    document.getElementById("totalBranches").textContent = Object.keys(branches).length;
    document.getElementById("avgAttendance").textContent = Math.round(totalAttendance/filtered.length);
    document.getElementById("topBranch").textContent = Object.entries(branches).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";
    document.getElementById("offeringPerPerson").textContent = (totalAttendance ? (totalOfferings/totalAttendance).toFixed(2) : 0);
    document.getElementById("totalFirstTimers").textContent = totalFirstTimers;
    document.getElementById("totalNewConverts").textContent = totalNewConverts;
    document.getElementById("conversionRate").textContent = (totalFirstTimers ? ((totalNewConverts/totalFirstTimers)*100).toFixed(2) : 0);
    document.getElementById("totalHeritage").textContent = totalHeritage;

    const colors = ["#6366f1","#22c55e","#facc15","#f87171"];

    // Destroy previous charts
    [branchChart, serviceChart, genderChart, offeringsChart, heritageChart].forEach(c=>c?.destroy());

    // Branch Chart horizontal
    const branchLabels = Object.keys(branches);
    const branchData = branchLabels.map(b=>branches[b]);
    branchChart = new Chart(document.getElementById("branchChart"),{
      type:"bar",
      data:{labels:branchLabels, datasets:[{data:branchData, backgroundColor:colors}]},
      options:{
        indexAxis:'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{beginAtZero:true}, y:{ticks:{autoSkip:false}}}
      }
    });

    // Service Chart
    serviceChart = new Chart(document.getElementById("serviceChart"),{
      type:"bar",
      data:{labels:Object.keys(services), datasets:[{data:Object.values(services), backgroundColor:colors}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
    });

    // Gender Chart
    genderChart = new Chart(document.getElementById("genderChart"),{
      type:"doughnut",
      data:{labels:["Male","Female"], datasets:[{data:[gender.Male,gender.Female], backgroundColor:["#6366f1","#22c55e"]}]},
      options:{responsive:true, maintainAspectRatio:false}
    });

    // Offerings Chart
    offeringsChart = new Chart(document.getElementById("offeringsChart"),{
      type:"doughnut",
      data:{labels:["Free Will","Tithe","Thanksgiving"], datasets:[{data:[
        filtered.reduce((s,r)=>s+r.offeringFreeWill,0),
        filtered.reduce((s,r)=>s+r.offeringTithe,0),
        filtered.reduce((s,r)=>s+r.offeringThanksgiving,0)
      ], backgroundColor:["#6366f1","#22c55e","#facc15"]}]},
      options:{responsive:true, maintainAspectRatio:false}
    });

    // Heritage vs Visitors
    heritageChart = new Chart(document.getElementById("heritageChart"),{
      type:"doughnut",
      data:{labels:["Heritage","Visitors"], datasets:[{data:[totalHeritage,totalAttendance-totalHeritage], backgroundColor:["#6366f1","#facc15"]}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  [branchSelect,dateFrom,dateTo].forEach(el=>el.addEventListener('change', renderDashboard));
  resetBtn.addEventListener('click',()=>{ branchSelect.value=""; dateFrom.value=""; dateTo.value=""; renderDashboard(); });

  renderDashboard();
}

document.addEventListener("DOMContentLoaded", initDashboard);
</script>

</body>
</html>
