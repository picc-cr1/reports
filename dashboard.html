<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICC CR1 Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="css/style.css">
<script src="js/nav.js" defer></script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f9f9f9; color:#333; }

/* Navbar */
nav.navbar { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#007BFF; color:#fff; }
nav.navbar .logo { font-weight:bold; font-size:1.2em; }
nav.navbar ul { list-style:none; display:flex; gap:15px; padding:0; margin:0; }
nav.navbar ul li a { color:#fff; text-decoration:none; }
nav.navbar ul li a.active { text-decoration:underline; }

/* Container & headings */
.container { padding:20px; max-width:1200px; margin:auto; }
h2 { color:#007BFF; margin-bottom:20px; }

/* Cards */
.card-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-bottom:30px; }
.card { background:#fff; border-radius:10px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; }
.card h3 { margin-top:0; font-size:1.1em; margin-bottom:10px; color:#007BFF; }
.card p { font-size:1.5em; font-weight:bold; margin:0; color:#333; }

canvas { width:100% !important; height:250px !important; }
.no-data { text-align:center; margin-top:20px; font-weight:bold; }
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo">PICC CR1</div>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
  <ul id="navLinks">
    <li><a href="index.html" class="active">Home</a></li>
    <li><a href="post.html">Post Report</a></li>
    <li class="has-submenu">
      <a href="reports.html">Reports</a>
      <ul class="submenu">
        <li><a href="reports.html" id="viewPDFLink">View</a></li>
        <li><a href="rep.html" id="downloadPDFLink">Download</a></li>
      </ul>
    </li>
    <li><a href="dashboard.html">Dashboard</a></li>
  </ul>
</nav>

<main class="container">
  <h2>Dashboard Insights</h2>

  <!-- Top metrics -->
  <div class="card-grid">
    <div class="card" id="totalAttendance"><h3>Total Attendance</h3><p>0</p></div>
    <div class="card" id="totalMale"><h3>Total Males</h3><p>0</p></div>
    <div class="card" id="totalFemale"><h3>Total Females</h3><p>0</p></div>
    <div class="card" id="totalBranches"><h3>Active Branches</h3><p>0</p></div>
  </div>

  <!-- Charts -->
  <div class="card-grid">
    <div class="card"><h3>Attendance by Branch</h3><canvas id="branchChart"></canvas></div>
    <div class="card"><h3>Attendance by Service Type</h3><canvas id="serviceChart"></canvas></div>
    <div class="card"><h3>Gender Split</h3><canvas id="genderChart"></canvas></div>
    <div class="card"><h3>Offering Distribution</h3><canvas id="offeringsChart"></canvas></div>
  </div>
</main>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3tGmvmBCkLxMpnfZwJSS6nwVXV2cj2NcBEXlLVLe2PdegU0Enw3R3qHcnzS5GxWdX/exec?action=getReports";

async function fetchData() {
  const res = await fetch(WEB_APP_URL);
  const data = await res.json();
  return data.reports || [];
}

function aggregateData(reports) {
  const metrics = { total:0, male:0, female:0, branches:new Set(), offerings:{FW:0,Tithe:0,Thanksgiving:0} };
  const branchAttendance = {};
  const serviceAttendance = {};
  const gender = { Male:0, Female:0 };

  reports.forEach(r=>{
    metrics.total += r.attendanceTotal;
    metrics.male += r.attendanceMale;
    metrics.female += r.attendanceFemale;
    metrics.branches.add(r.branch);

    branchAttendance[r.branch] = (branchAttendance[r.branch] || 0) + r.attendanceTotal;
    serviceAttendance[r.serviceType] = (serviceAttendance[r.serviceType] || 0) + r.attendanceTotal;
    gender.Male += r.attendanceMale;
    gender.Female += r.attendanceFemale;

    metrics.offerings.FW += r.offeringFreeWill;
    metrics.offerings.Tithe += r.offeringTithe;
    metrics.offerings.Thanksgiving += r.offeringThanksgiving;
  });

  return { metrics, branchAttendance, serviceAttendance, gender };
}

async function initDashboard() {
  const reports = await fetchData();
  if(!reports.length){
    document.querySelector(".container").innerHTML += "<p class='no-data'>No data available.</p>";
    return;
  }

  const { metrics, branchAttendance, serviceAttendance, gender } = aggregateData(reports);

  document.getElementById("totalAttendance").querySelector("p").textContent = metrics.total;
  document.getElementById("totalMale").querySelector("p").textContent = metrics.male;
  document.getElementById("totalFemale").querySelector("p").textContent = metrics.female;
  document.getElementById("totalBranches").querySelector("p").textContent = metrics.branches.size;

  const mainColor = '#007BFF'; // solid blue

  // Branch chart
  new Chart(document.getElementById("branchChart").getContext("2d"), {
    type:'bar',
    data:{ labels:Object.keys(branchAttendance), datasets:[{ label:'Attendance', data:Object.values(branchAttendance), backgroundColor:mainColor }] },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
  });

  // Service chart
  new Chart(document.getElementById("serviceChart").getContext("2d"), {
    type:'bar',
    data:{ labels:Object.keys(serviceAttendance), datasets:[{ label:'Attendance', data:Object.values(serviceAttendance), backgroundColor:mainColor }] },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
  });

  // Gender chart
  new Chart(document.getElementById("genderChart").getContext("2d"), {
    type:'doughnut',
    data:{ labels:['Male','Female'], datasets:[{ data:[gender.Male,gender.Female], backgroundColor:[mainColor,'#339CFF'] }] },
    options:{ responsive:true }
  });

  // Offerings chart
  new Chart(document.getElementById("offeringsChart").getContext("2d"), {
    type:'doughnut',
    data:{ labels:['Free Will','Tithe','Thanksgiving'], datasets:[{ data:[metrics.offerings.FW, metrics.offerings.Tithe, metrics.offerings.Thanksgiving], backgroundColor:[mainColor,'#339CFF','#66B2FF'] }] },
    options:{ responsive:true }
  });
}

document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
