<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICC CR1 Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="css/style.css">
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f9f9f9; color:#333; }

/* Navbar */
nav.navbar { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#007BFF; color:#fff; }
nav.navbar .logo { font-weight:bold; font-size:1.2em; }
nav.navbar ul { list-style:none; display:flex; gap:15px; padding:0; margin:0; }
nav.navbar ul li a { color:#fff; text-decoration:none; }
nav.navbar ul li a.active { text-decoration:underline; }

/* Container & headings */
.container { padding:20px; max-width:1200px; margin:auto; }
h2 { color:#007BFF; margin-bottom:20px; }

/* Filters */
.filters { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; align-items:center; }
.filters label { font-weight:bold; }
.filters input, .filters select { padding:5px 10px; border-radius:5px; border:1px solid #ccc; }

/* Cards */
.card-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-bottom:30px; }
.card { background:#fff; border-radius:10px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; }
.card h3 { margin-top:0; font-size:1.1em; margin-bottom:10px; color:#007BFF; }
.card p { font-size:1.5em; font-weight:bold; margin:0; color:#333; }

canvas { width:100% !important; height:250px !important; }
.no-data { text-align:center; margin-top:20px; font-weight:bold; color:#555; }

button { cursor:pointer; }
</style>
</head>
<body>

<div id="nav-placeholder"></div>

<main class="container">
  <h2>Dashboard Insights</h2>

  <!-- Filters -->
  <div class="filters">
    <label>Branch: <select id="branchSelect"><option value="">All</option></select></label>
    <label>Month: <select id="monthSelect"><option value="">All</option></select></label>
    <label>From: <input type="date" id="dateFrom"></label>
    <label>To: <input type="date" id="dateTo"></label>
    <button id="resetFilters">Reset Filters</button>
  </div>

  <!-- Top KPIs -->
  <div class="card-grid">
    <div class="card" id="totalAttendance"><h3>Total Attendance</h3><p>0</p></div>
    <div class="card" id="avgAttendance"><h3>Avg Attendance/Service</h3><p>0</p></div>
    <div class="card" id="attendanceGrowth"><h3>Attendance Growth %</h3><p>0%</p></div>
    <div class="card" id="offeringPerAttendee"><h3>Offering per Attendee</h3><p>0</p></div>
    <div class="card" id="mostActiveBranch"><h3>Most Active Branch</h3><p>-</p></div>
    <div class="card" id="firstTimerRate"><h3>1st Timer Conversion %</h3><p>0%</p></div>
  </div>

  <!-- Charts -->

  <!-- Row 1: Attendance by Branch -->
  <div class="card-grid" style="grid-template-columns:1fr;">
    <div class="card"><h3>Attendance by Branch</h3><canvas id="branchChart"></canvas></div>
  </div>

  <!-- Row 2: Attendance by Service Type -->
  <div class="card-grid" style="grid-template-columns:1fr;">
    <div class="card"><h3>Attendance by Service Type</h3><canvas id="serviceChart"></canvas></div>
  </div>

  <!-- Row 3: Gender Split & Offering Distribution -->
  <div class="card-grid">
    <div class="card"><h3>Gender Split</h3><canvas id="genderChart"></canvas></div>
    <div class="card"><h3>Offering Distribution</h3><canvas id="offeringsChart"></canvas></div>
  </div>
</main>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3tGmvmBCkLxMpnfZwJSS6nwVXV2cj2NcBEXlLVLe2PdegU0Enw3R3qHcnzS5GxWdX/exec?action=getReports";
let reportData = [];

// Load nav
fetch('nav.html')
  .then(r => r.text())
  .then(html => document.getElementById('nav-placeholder').innerHTML = html);

// Fetch and cache data
async function fetchReports() {
  const cached = localStorage.getItem('reportsCache');
  if (cached) return JSON.parse(cached);

  const res = await fetch(WEB_APP_URL);
  const data = await res.json();
  localStorage.setItem('reportsCache', JSON.stringify(data.reports || []));
  return data.reports || [];
}

// Initialize filters
function initFilters() {
  const branchSet = new Set(reportData.map(r => r.branch));
  const branchSelect = document.getElementById('branchSelect');
  branchSelect.innerHTML = '<option value="">All</option>';
  branchSet.forEach(b => branchSelect.innerHTML += `<option value="${b}">${b}</option>`);

  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthSelect = document.getElementById('monthSelect');
  monthSelect.innerHTML = '<option value="">All</option>';
  monthNames.forEach((m, idx) => monthSelect.innerHTML += `<option value="${idx+1}">${m}</option>`);
}

// Filter reports
function filterReports() {
  const branch = document.getElementById('branchSelect').value;
  const month = document.getElementById('monthSelect').value;
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;

  return reportData.filter(r => {
    let keep = true;
    if(branch) keep = keep && r.branch === branch;

    const serviceDate = new Date(r.serviceDate);

    if(from && to){
      keep = keep && serviceDate >= new Date(from) && serviceDate <= new Date(to);
    } else if(month){
      keep = keep && serviceDate.getMonth()+1 === Number(month);
    }
    return keep;
  });
}

// Aggregate KPIs
function computeKPIs(reports) {
  if(!reports.length) return {
    total:0, avg:0, growth:0, offeringPer:0, activeBranch:'-', firstTimerRate:0,
    branchAttendance:{}, serviceAttendance:{}, gender:{Male:0,Female:0}, offerings:{FW:0,Tithe:0,Thanksgiving:0}
  };

  const metrics = { total:0, male:0, female:0, firstTimers:0, branches:new Set(), offerings:{FW:0,Tithe:0,Thanksgiving:0} };
  const branchAttendance = {};
  const serviceAttendance = {};
  const gender = { Male:0, Female:0 };

  reports.forEach(r=>{
    metrics.total += r.attendanceTotal;
    metrics.male += r.attendanceMale;
    metrics.female += r.attendanceFemale;
    metrics.firstTimers += r.attendanceFirstTimers;
    metrics.branches.add(r.branch);

    branchAttendance[r.branch] = (branchAttendance[r.branch]||0) + r.attendanceTotal;
    serviceAttendance[r.serviceType] = (serviceAttendance[r.serviceType]||0) + r.attendanceTotal;
    gender.Male += r.attendanceMale;
    gender.Female += r.attendanceFemale;

    metrics.offerings.FW += r.offeringFreeWill;
    metrics.offerings.Tithe += r.offeringTithe;
    metrics.offerings.Thanksgiving += r.offeringThanksgiving;
  });

  const avg = metrics.total/reports.length;
  let growth = 0;
  const sorted = reports.slice().sort((a,b)=> new Date(a.serviceDate)-new Date(b.serviceDate));
  if(sorted.length>1){
    const prev = sorted[sorted.length-2].attendanceTotal;
    const last = sorted[sorted.length-1].attendanceTotal;
    growth = prev ? Math.round(((last-prev)/prev)*100) : 0;
  }

  const offeringPer = metrics.total ? ((metrics.offerings.FW + metrics.offerings.Tithe + metrics.offerings.Thanksgiving)/metrics.total).toFixed(2) : 0;
  const activeBranch = Object.entries(branchAttendance).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
  const firstTimerRate = metrics.total ? Math.round((metrics.firstTimers/metrics.total)*100) : 0;

  return { total:metrics.total, avg, growth, offeringPer, activeBranch, firstTimerRate, branchAttendance, serviceAttendance, gender, offerings:metrics.offerings };
}

// Charts
let branchChart, serviceChart, genderChart, offeringsChart;
function renderCharts(kpis) {
  const mainColor = '#007BFF';

  if(branchChart) branchChart.destroy();
  branchChart = new Chart(document.getElementById("branchChart"), {
    type:'bar',
    data:{ labels:Object.keys(kpis.branchAttendance), datasets:[{ label:'Attendance', data:Object.values(kpis.branchAttendance), backgroundColor:mainColor }] },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
  });

  if(serviceChart) serviceChart.destroy();
  serviceChart = new Chart(document.getElementById("serviceChart"), {
    type:'bar',
    data:{ labels:Object.keys(kpis.serviceAttendance), datasets:[{ label:'Attendance', data:Object.values(kpis.serviceAttendance), backgroundColor:mainColor }] },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
  });

  if(genderChart) genderChart.destroy();
  genderChart = new Chart(document.getElementById("genderChart"), {
    type:'doughnut',
    data:{ labels:['Male','Female'], datasets:[{ data:[kpis.gender.Male,kpis.gender.Female], backgroundColor:[mainColor,'#339CFF'] }] },
    options:{ responsive:true }
  });

  if(offeringsChart) offeringsChart.destroy();
  offeringsChart = new Chart(document.getElementById("offeringsChart"), {
    type:'doughnut',
    data:{ labels:['Free Will','Tithe','Thanksgiving'], datasets:[{ data:[kpis.offerings.FW,kpis.offerings.Tithe,kpis.offerings.Thanksgiving], backgroundColor:[mainColor,'#339CFF','#66B2FF'] }] },
    options:{ responsive:true }
  });
}

// Render KPIs
function renderKPIs(kpis){
  document.getElementById("totalAttendance").querySelector("p").textContent = kpis.total;
  document.getElementById("avgAttendance").querySelector("p").textContent = kpis.avg.toFixed(0);
  document.getElementById("attendanceGrowth").querySelector("p").textContent = kpis.growth + "%";
  document.getElementById("offeringPerAttendee").querySelector("p").textContent = kpis.offeringPer;
  document.getElementById("mostActiveBranch").querySelector("p").textContent = kpis.activeBranch;
  document.getElementById("firstTimerRate").querySelector("p").textContent = kpis.firstTimerRate + "%";
}

// Apply filters
function applyFilters() {
  const filtered = filterReports();
  const kpis = computeKPIs(filtered);
  renderKPIs(kpis);
  renderCharts(kpis);
}

// Reset filters
document.getElementById('resetFilters').addEventListener('click', () => {
  document.getElementById('branchSelect').value = "";
  document.getElementById('monthSelect').value = "";
  document.getElementById('dateFrom').value = "";
  document.getElementById('dateTo').value = "";
  applyFilters();
});

// Filter listeners
['branchSelect','monthSelect','dateFrom','dateTo'].forEach(id=>{
  document.getElementById(id).addEventListener('change', applyFilters);
});

// Init dashboard
async function initDashboard(){
  reportData = await fetchReports();
  if(!reportData.length) { document.querySelector(".container").innerHTML += "<p class='no-data'>No data available.</p>"; return; }
  initFilters();
  applyFilters();
}
document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
