<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports | PICC CR1</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="css/style.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* HERO STYLES (DO NOT TOUCH) */
.hero {
  background: radial-gradient(1200px 500px at top right, rgba(99,102,241,0.15), #fff);
  border-radius: 16px;
  padding: 40px 30px;
  box-shadow: 0 20px 40px rgba(0,0,0,.08);
  margin-bottom: 30px;
  text-align: center;
}
.hero h1 { font-size: 2rem; font-weight: 700; color: #2980b9; margin-bottom: 10px; }
.hero p { font-size: 1rem; color: #64748b; max-width: 700px; margin: 0 auto; }

/* 1. BUTTONS & CONTROLS */
.controls { 
    margin-bottom: 2rem; display: flex; flex-wrap: wrap; gap: 12px; background: #f8fafc;
    padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;
}
.controls button { 
    padding: 0.6rem 1.2rem; border: none; border-radius: 8px; color: #fff; 
    cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;
}
#cardsViewBtn { background: #6366f1; } 
#tableViewBtn { background: #64748b; } 
#downloadPDF { background: #10b981; }  
#resetFilters { background: #ef4444; } 

/* 2. FILTERS */
.filters.form-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px; background: #fff; padding: 20px; border-radius: 12px;
    border: 1px solid #e2e8f0; margin-bottom: 2rem; align-items: end;
}
.filters label { display: flex; flex-direction: column; font-size: 0.85rem; font-weight: 600; color: #475569; gap: 8px; }
.filters select, .filters input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: inherit; }

/* 3. CARDS DESIGN */
.cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
.report-card { 
    background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
    border: 1px solid #f1f5f9; transition: transform 0.2s;
}
.report-card:hover { transform: translateY(-5px); }
.report-card .line-1 { font-weight: 700; font-size: 1.1rem; border-left: 4px solid #6366f1; padding-left: 12px; margin-bottom: 4px; }
.report-card .line-2 { color: #6366f1; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px; padding-left: 16px; }
.report-card .stats-group { background: #f8fafc; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
.report-card .attendance, .report-card .offerings { font-size: 0.85rem; color: #475569; line-height: 1.6; }
.report-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-top: 15px; }

/* 4. TABLE RESPONSIVENESS & DUAL SCROLLBARS */
.landscape-tip {
    display: none; /* Hidden by default */
    background: #fff9c4; color: #856404; padding: 10px; border-radius: 8px;
    margin-bottom: 10px; font-size: 0.85rem; font-weight: 600; border: 1px solid #ffeeba;
}
.top-scrollbar-wrapper {
    width: 100%; overflow-x: auto; overflow-y: hidden; height: 15px; margin-bottom: 0px;
}
.top-scrollbar-content { height: 15px; } /* Dynamic width set via JS */

.table-responsive {
    width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
    border-radius: 0 0 12px 12px; border: 1px solid #e2e8f0; background: #fff;
}
table { width: 100%; min-width: 1000px; border-collapse: collapse; }
th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.8rem; }
td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }

/* Show tip only on small screens */
@media(max-width: 768px) {
    .landscape-tip { display: block; }
}

/* NAVIGATION (DO NOT TOUCH) */
.plug-nav { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; padding:0.9rem 1.4rem; background-color:#0f172a; color:#fff; }
.plug-nav__brand { font-weight:700; font-size:1.05rem; letter-spacing:0.04em; }
.plug-nav__brand span { color: #6366f1; }
.plug-nav__links { list-style:none; display:flex; align-items:center; gap:1.5rem; margin:0; padding:0; }
.plug-nav__links a { color:#e5e7eb; font-size:0.95rem; font-weight:500; text-decoration:none; }
.plug-nav__links a:hover, .plug-nav__links a.active { color:#fff; }
.plug-nav__toggle { display:none; background:none; border:none; color:#fff; font-size:1.6rem; cursor:pointer; }
@media(max-width:768px){
  .plug-nav__toggle { display:block; }
  .plug-nav__links { display:none; flex-direction:column; gap:0.8rem; margin-top:0.8rem; width:100%; }
  .plug-nav__links.show { display:flex; }
}

.container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem 4rem; }
.no-data { text-align: center; color: #64748b; padding: 40px; }
.report-legend { text-align: center; font-size: 0.85rem; color: #64748b; margin-top: 2rem; padding: 20px; background: #f8fafc; border-radius: 8px; }
</style>
</head>

<body>

<div id="nav-placeholder"></div>

<main class="container">

  <section class="hero">
    <h1>Submitted Reports</h1>
    <p>View all submitted service reports with attendance and offerings breakdown.</p>
  </section>

  <div class="controls">
    <button id="cardsViewBtn" class="active">üóÇÔ∏è Cards View</button>
    <button id="tableViewBtn">üìä Table View</button>
    <button id="downloadPDF">üì• Download PDF</button>
    <button id="resetFilters">üîÑ Reset Filters</button>
  </div>

  <div class="filters form-grid">
    <label>Branch
      <select id="branchSelect">
        <option value="">All Branches</option>
        <option value="Ntcheu">Ntcheu</option>
        <option value="Salima">Salima</option>
        <option value="Mtakataka">Mtakataka</option>
        <option value="Bilira">Bilira</option>
        <option value="Dedza">Dedza</option>
        <option value="Njewa">Njewa</option>
        <option value="Mitundu">Mitundu</option>
        <option value="Mchezi">Mchezi</option>
        <option value="Area 25">Area 25</option>
        <option value="Hope Tabernacle">Hope Tabernacle</option>
        <option value="Area 23">Area 23</option>
        <option value="Old Town">Old Town</option>
        <option value="Area 18">Area 18</option>
        <option value="Area 56">Area 56</option>
      </select>
    </label>
    <label>From Date <input type="date" id="dateFrom"></label>
    <label>To Date <input type="date" id="dateTo"></label>
  </div>

  <div id="reportsContainer">
    <p class="no-data">Loading reports...</p>
  </div>

</main>

<div id="reportLegend" class="report-legend">
  <strong>Legend:</strong><br>
  M: Male | F: Female | H: Heritage | FT: First Timers | NC: New Converts | TOT.ATT: Total Attendance<br>
  FW: Free Will | TG: Thanksgiving | TOT.OFF: Total Offering
</div>

<script>
/* NAVBAR LOGIC (UNTOUCHED) */
fetch('nav.html')
  .then(res => res.text())
  .then(html => {
    const navContainer = document.getElementById('nav-placeholder');
    navContainer.innerHTML = html;
    const toggleBtn = navContainer.querySelector('.plug-nav__toggle');
    const links = navContainer.querySelector('.plug-nav__links');
    if(toggleBtn && links){
      toggleBtn.addEventListener('click', () => links.classList.toggle('show'));
    }
  })
  .catch(err => console.error('Failed to load navbar:', err));

/* REPORTS LOGIC */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3tGmvmBCkLxMpnfZwJSS6nwVXV2cj2NcBEXlLVLe2PdegU0Enw3R3qHcnzS5GxWdX/exec?action=getReports";
let reportData = [];
let currentView = 'cards';

function n(val){ return Number(val) || 0; }
function formatDate(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  if(isNaN(d)) return "-";
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}
function normalizeDate(value) {
  if(!value) return "";
  const d = new Date(value);
  if(isNaN(d)) return "";
  return d.toISOString().split('T')[0];
}

async function fetchReports(){
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    reportData = data.reports || [];
    renderView();
  } catch(err){
    document.getElementById("reportsContainer").innerHTML = '<p class="no-data">Failed to load reports.</p>';
  }
}

function filterReports(){
  const branch = document.getElementById("branchSelect").value;
  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;
  return reportData.filter(r=>{
    const serviceDate = normalizeDate(r.serviceDate);
    if(!serviceDate) return false;
    if(branch && r.branch!==branch) return false;
    if(from && serviceDate<from) return false;
    if(to && serviceDate>to) return false;
    return true;
  });
}

function renderView(){
  const container = document.getElementById("reportsContainer");
  container.innerHTML="";
  const filtered = filterReports();
  if(!filtered.length){ container.innerHTML='<p class="no-data">No reports found.</p>'; return; }

  if(currentView==='cards'){
    const cardsDiv = document.createElement("div");
    cardsDiv.className="cards-container";
    filtered.forEach(r=>{
      const card=document.createElement("div");
      card.className="report-card";
      card.innerHTML=`
        <div class="line-1">${r.branch||'‚Äî'} ‚Äî ${r.pastorName||'‚Äî'}</div>
        <div class="line-2">${r.serviceType||'Service'} ‚Ä¢ ${formatDate(r.serviceDate)}</div>
        <div class="stats-group">
            <div class="attendance"><strong>Attendance:</strong> M:${n(r.attendanceMale)} F:${n(r.attendanceFemale)} H:${n(r.attendanceHeritage)} FT:${n(r.attendanceFirstTimers)} NC:${n(r.attendanceNewConverts)}</div>
            <div class="attendance"><strong>Total:</strong> ${n(r.attendanceTotal)}</div>
        </div>
        <div class="stats-group">
            <div class="offerings"><strong>Offerings:</strong> FW:${n(r.offeringFreeWill)} T:${n(r.offeringTithe)} TG:${n(r.offeringThanksgiving)}</div>
            <div class="offerings"><strong>Total:</strong> ${n(r.offeringTotal)}</div>
        </div>
        ${r.evidenceURL?`<img src="${r.evidenceURL}" alt="Evidence">`:''}
      `;
      cardsDiv.appendChild(card);
    });
    container.appendChild(cardsDiv);
  } else {
    // 1. Landscape Tip
    const tip = document.createElement("div");
    tip.className = "landscape-tip";
    tip.innerHTML = "üí° Tip: For the best table view, consider turning your phone to landscape mode. or use the slider below";
    container.appendChild(tip);

    // 2. Dual Scroll - Top Scrollbar Wrapper
    const topScrollWrapper = document.createElement("div");
    topScrollWrapper.className = "top-scrollbar-wrapper";
    const topScrollContent = document.createElement("div");
    topScrollContent.className = "top-scrollbar-content";
    topScrollWrapper.appendChild(topScrollContent);
    container.appendChild(topScrollWrapper);

    // 3. Table Wrapper
    const tableWrapper = document.createElement("div");
    tableWrapper.className = "table-responsive";
    
    const table=document.createElement("table");
    const headers=["Branch","Pastor","Service","Custom","Date","M","F","H","FT","NC","TOT.ATT","FW","Tithe","TG","TOT.OFF"];
    const thead=document.createElement("thead");
    const trHead=document.createElement("tr");
    headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trHead.appendChild(th); });
    thead.appendChild(trHead);
    table.appendChild(thead);
    
    const tbody=document.createElement("tbody");
    filtered.forEach(r=>{
      const tr=document.createElement("tr");
      const cells=[r.branch,r.pastorName,r.serviceType,r.customServiceName||"-",formatDate(r.serviceDate),n(r.attendanceMale), n(r.attendanceFemale), n(r.attendanceHeritage), n(r.attendanceFirstTimers), n(r.attendanceNewConverts), n(r.attendanceTotal),n(r.offeringFreeWill), n(r.offeringTithe), n(r.offeringThanksgiving), n(r.offeringTotal)];
      cells.forEach(c=>{ const td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    tableWrapper.appendChild(table);
    container.appendChild(tableWrapper);

    // DUAL SCROLL SYNC LOGIC
    // Set width of top scroll content to match table width
    setTimeout(() => {
        topScrollContent.style.width = table.scrollWidth + "px";
    }, 100);

    topScrollWrapper.onscroll = function() {
        tableWrapper.scrollLeft = topScrollWrapper.scrollLeft;
    };
    tableWrapper.onscroll = function() {
        topScrollWrapper.scrollLeft = tableWrapper.scrollLeft;
    };
  }
}

/* INTERACTION LOGIC */
document.getElementById("cardsViewBtn").addEventListener('click',()=>{ 
    currentView='cards'; 
    document.getElementById("cardsViewBtn").classList.add('active');
    document.getElementById("tableViewBtn").classList.remove('active');
    renderView(); 
});
document.getElementById("tableViewBtn").addEventListener('click',()=>{ 
    currentView='table'; 
    document.getElementById("tableViewBtn").classList.add('active');
    document.getElementById("cardsViewBtn").classList.remove('active');
    renderView(); 
});
document.getElementById("downloadPDF").addEventListener('click',()=>{
  const filtered = filterReports();
  if(!filtered.length) return alert("No data to download.");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","pt","a4");
  const headers=["Branch","Pastor","Service","Custom","Date","M","F","H","FT","NC","TOT.ATT","FW","Tithe","TG","TOT.OFF"];
  const rows=filtered.map(r=>[r.branch,r.pastorName,r.serviceType,r.customServiceName||"-",formatDate(r.serviceDate),n(r.attendanceMale), n(r.attendanceFemale), n(r.attendanceHeritage), n(r.attendanceFirstTimers), n(r.attendanceNewConverts), n(r.attendanceTotal),n(r.offeringFreeWill), n(r.offeringTithe), n(r.offeringThanksgiving), n(r.offeringTotal)]);
  doc.autoTable({ head:[headers], body:rows, startY:30, styles:{fontSize:8}, headStyles:{fillColor:[22,160,133]}, theme:"grid" });
  doc.save("Reports.pdf");
});

document.getElementById('resetFilters').addEventListener('click',()=>{
  document.getElementById('branchSelect').value="";
  document.getElementById('dateFrom').value="";
  document.getElementById('dateTo').value="";
  renderView();
});

['branchSelect','dateFrom','dateTo'].forEach(id=>{
  document.getElementById(id).addEventListener('change',renderView);
});
document.addEventListener("DOMContentLoaded", fetchReports);
</script>
</body>
</html>
